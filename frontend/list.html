<!DOCTYPE HTML>
<!--
  @licstart  The following is the entire license notice for the JavaScript code in this page.
  The JavaScript code in this page is free software: you can
  redistribute it and/or modify it under the terms of the GNU
  General Public License (GNU GPL) as published by the Free Software
  Foundation, either version 3 of the License, or (at your option)
  any later version.  The code is distributed WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS
  FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

  As additional permission under GNU GPL version 3 section 7, you
  may distribute non-source (e.g., minimized or compacted) forms of
  that code without the copy of the GNU GPL normally required by
  section 4, provided you include this license notice and a URL
  through which recipients can access the Corresponding Source.
  @licend  The above is the entire license notice
-->
<head>
<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://tls.homeinfo.de/libs/bootstrap/latest/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://tls.homeinfo.de/libs/sweetalert/dist/sweetalert.css">
  <!--<link rel="stylesheet" href="immobrowse.css">-->
  <script src="https://tls.homeinfo.de/libs/jquery/jquery-latest.min.js"></script>
  <script src="https://tls.homeinfo.de/libs/bootstrap/latest/js/bootstrap.min.js"></script>
  <script src="https://tls.homeinfo.de/libs/sweetalert/dist/sweetalert.min.js"></script>
  <script src="https://tls.homeinfo.de/javascript/homeinfo.js"></script>
  <script src="https://tls.homeinfo.de/javascript/immobrowse.js"></script>
  <script src="config.js"></script>
  <script>
    var cid = location.search.slice(1);
    var exposeUrl = 'expose.html?cid={cid}&extern={objektnr_extern}';
    var sorting = {
      property: null,
      order: null
    };
    var list;
    var container;
    var districts;

    function toggleOrder() {
      var previousOrder = sorting.order;

      if (sorting.order == 'descending') {
        sorting.order = 'ascending';
      } else {
        sorting.order = 'descending';
      }

      return previousOrder;
    }

    function toggleSorting(property) {
      var previousIssuer = document.getElementById('ib-sort-' + sorting.property);
      var issuer = document.getElementById('ib-sort-' + property);
      toggleOrder();
      sorting.property = property;

      // Remove arrow symbol
      if (previousIssuer != null) {
        previousIssuer.innerHTML = previousIssuer.innerHTML.slice(0, -1);
      }

      switch (sorting.order) {
        case 'ascending':
          issuer.innerHTML += ' &darr;';
          break;
        case 'descending':
          issuer.innerHTML += ' &uarr;';
          break;
      }

      list.sort(sorting.property, sorting.order);
      list.render(container);
    }

    function selectedDistricts() {
      var districts = [];
      var checkboxes = document.getElementsByClassName('ib-select-district');

      for (i = 0; i < checkboxes.length; i++) {
        if (checkboxes[i].checked) {
          districts.push(checkboxes[i].getAttribute('subject'));
        }
      }

      return districts;
    }

    function filters() {
      var priceMax = Number(homeinfo.str.comma2dot($('#ib-price-max').val()));
      var filters = {
        types: immobrowse.config.types,
        marketing: immobrowse.config.marketing,
        priceMin: Number(homeinfo.str.comma2dot($('#ib-price-min').val())),
        priceMax: priceMax == 0 ? Infinity: priceMax,
        areaMin: Number(homeinfo.str.comma2dot($('#ib-area-min').val())),
        roomsMin: Number(homeinfo.str.comma2dot($('#ib-rooms-min').val())),
        ebk: $("#ib-filter-kitchen").is(':checked'),
        bathtub: $("#ib-filter-bathtub").is(':checked'),
        window: $("#ib-filter-window").is(':checked'),
        balcony: $("#ib-filter-balcony").is(':checked'),
        carSpace: $("#ib-filter-carspace").is(':checked'),
        guestwc: $("#ib-filter-guestwc").is(':checked'),
        elevator: $("#ib-filter-elevator").is(':checked'),
        garden: $("#ib-filter-garden").is(':checked'),
        districts: selectedDistricts()
      }

      immobrowse.logger.debug('Filters:');
      immobrowse.logger.debug(JSON.stringify(filters));
      return filters;
    }

    function filter() {
      list.filter(filters());

      if (sorting.property != null) {
        list.sort(sorting.property, sorting.order);
      }

      list.render(container);
    }

    $(document).ready(function () {
      $('#ib-extsearch-button').click(function() {
        if ($('#ib-extsearch').attr('style') == "display: none;")
          $('#ib-extsearch').slideDown();
        else
          $('#ib-extsearch').slideUp();
      });

      $('.ib-btn-filter-option').on('input',function(e) {
        filter();
      });

      $('.ib-filter-amenities-option').click(function() {
        filter();
      });

      var districtsElement = document.getElementById('ib-districts');
      districtsElement.innerHTML = '';

      var elements = {
        prices: {
          coldRent: $('#coldRent'),
          serviceCharge: $('#serviceCharge'),
          heatingCosts: null,
          heatingCostsInServiceCharge: null,
          securityDeposit: null,
          subjectToCommission: null
        },
        area: {
          livingArea: $('#livingArea'),
          rooms: $('#rooms')
        },
        geo: {
          floor: null
        },
        management: {
          availableFrom: null,
          councilFlat: null
        },
        state: {
          constructionYear: null,
          state: null,
          lastModernization: null,
          energyCertificate: {
            type: null,
            consumption: null,
            primaryEnergyCarrier: null,
            valueClass: null
          }
        },
        freeTexts: {
          objectTitle: $('#objectTitle'),
          description: null,
          exposure: null,
          miscellanea: null
        },
        contact: {
          salutation: null,
          firstName: null,
          lastName: null,
          company: null,
          street: null,
          houseNumber: null,
          streetAndHouseNumber: null,
          zipCode: null,
          city: null,
          zipCodeAndCity: null,
          website: null
        },
        furnishingTags: $('#furnishingTags'),
        titleImage: $('#titleImage')
      };

      immobrowse.logger.debug('Elements: ' + JSON.stringify(elements));

      immobrowse.getRealEstates(cid, function (realEstates) {
        list = new immobrowse.List(cid, realEstates);
        districts = list.districts();
        list.filter(filters());

        for (district in districts) {
          districtsElement.innerHTML += '<input type="checkbox" class="ib-select-district" subject="'
            + district + '" onclick="filter();"> ' + district + ' (' + districts[district] + ')' + '</input><br>';
        }

        list.render($('#ib-list'), $('#ib-list-item-template'), elements);
        $('#ib-loader').hide();
      });
    });
  </script>
</head>

<div id="ib-centerframe" class="container">
  <div id="ib-header" class="row row-centered">
    <div class="col-md-3 col-centered">
      <div class="item">
        <div class="content">
          <button id="ib-sort-rooms" onclick="toggleSorting('rooms');" class="btn btn-primary ib-btn-sort" align="left">Zimmer</button>
          <button id="ib-sort-area" onclick="toggleSorting('area');" class="btn btn-primary ib-btn-sort" align="left">Fl&auml;che</button>
          <button id="ib-sort-street" onclick="toggleSorting('street');" class="btn btn-primary ib-btn-sort" align="left">Stra&szlig;e</button>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="item">
        <div class="content">
          <input id="ib-price-min" class="form-control ib-btn-filter-option" type="number" placeholder="Preis von">
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="item">
        <div class="content">
          <input id="ib-price-max" class="form-control ib-btn-filter-option" type="number" placeholder="Preis bis">
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="item">
        <div class="content">
          <input id="ib-area-min" class="form-control ib-btn-filter-option" type="number" placeholder="Größe ab in m²">
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="item">
        <div class="content">
          <input id="ib-rooms-min" class="form-control ib-btn-filter-option" type="number" placeholder="Zimmer ab">
        </div>
      </div>
    </div>
    <div class="col-md-1">
      <div class="item">
        <div class="content">
          <button id="ib-extsearch-button" class="btn btn-default">Erweitert</button>
        </div>
      </div>
    </div>
  </div>
  <div class="row row-centered">
    <div id="ib-extsearch" style="display: none;">
      <div class="container">
        <div class="row row-centered">
          <div class="col-xs-6 col-centered">
            <label><strong>Austattung</strong></label><br>
            <input type="checkbox" class="ib-filter-amenities-option" id="ib-filter-kitchen" onclick="filter();"> Einbauküche (EBK)<br>
            <input type="checkbox" class="ib-filter-amenities-option" id="ib-filter-bathtub" onclick="filter();"> Badewanne<br>
            <input type="checkbox" class="ib-filter-amenities-option" id="ib-filter-window" onclick="filter();"> Fenster im Bad<br>
            <input type="checkbox" class="ib-filter-amenities-option" id="ib-filter-balcony" onclick="filter();"> Balkon<br>
            <input type="checkbox" class="ib-filter-amenities-option" id="ib-filter-carspace" onclick="filter();"> Stellplatz<br>
            <input type="checkbox" class="ib-filter-amenities-option" id="ib-filter-guestwc" onclick="filter();"> Gäste-WC<br>
            <input type="checkbox" class="ib-filter-amenities-option" id="ib-filter-elevator" onclick="filter();"> Fahrstuhl<br>
            <input type="checkbox" class="ib-filter-amenities-option" id="ib-filter-garden" onclick="filter();"> Gartennutzung<br>
          </div>
          <div class="col-xs-6 col-centered">
            <label><strong>Stadtteile</strong></label><br>
            <div id="ib-districts"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="ib-body" class="row row-centered">
    <div id="ib-loader"></div>
    <div id="ib-list-item-template-container">
      <div id="ib-list-item-template" class="container">
        <div class="row">
          <div class="col">
            <img id="titleImage" class="img-responsive" alt="Titelbild">
          </div>
          <div class="col">
            <div class="container">
              <div id="objectTitle" class="row"></div>
              <div class="row">
                <div class="col">
                  <div class="container">
                    <div class="row">Kaltmiete</div>
                    <div id="coldRent" class="row"></div>
                  </div>
                </div>
                <div class="col">
                  <div class="container">
                    <div class="ib-preview-data-caption">Nebenkosten</div>
                    <div id="serviceCharge" class="row"></div>
                  </div>
                </div>
                <div class="col">
                  <div class="container">
                    <div class="ib-preview-data-caption">Zimmer</div>
                    <div id="rooms" class="row"></div>
                  </div>
                </div>
                <div class="col">
                  <div class="container">
                    <div class="ib-preview-data-caption">Fläche</div>
                    <div id="livingArea" class="row"></div>
                  </div>
                </div>
              </div>
              <div id="furnishingTags" class="row"></div>
            </div>
          </div>
        </div>
        <div id="objectTitle"></div>
        <div id="consumption"></div>
      </div>
    </div>
    <div id="ib-list">
      Immobilien werden geladen, bitte warten...
    </div>
  </div>
</div>
